package com.example.genetics

import android.content.Intent
import android.os.Bundle
import android.util.Log
import android.widget.Toast
import androidx.appcompat.app.AppCompatActivity
import androidx.lifecycle.lifecycleScope
import com.example.genetics.Activitys.DashboardActivity
import com.example.genetics.Activitys.UserDashboardActivity
import com.example.genetics.api.RetrofitClient
import kotlinx.coroutines.delay
import kotlinx.coroutines.launch

class MainActivity : AppCompatActivity() {

    private var isProcessing = false

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContentView(R.layout.activity_main)

        Log.d("MAIN_ACTIVITY", "üöÄ ===== INICIANDO GENETICS APP =====")
        Log.d("MAIN_ACTIVITY", "üì± Dispositivo: ${android.os.Build.MODEL}")
        Log.d("MAIN_ACTIVITY", "ü§ñ Android: ${android.os.Build.VERSION.RELEASE}")

        // Evitar m√∫ltiples inicializaciones
        if (isProcessing) {
            Log.w("MAIN_ACTIVITY", "‚ö†Ô∏è Ya se est√° procesando el inicio")
            return
        }
        isProcessing = true

        initializeApp()
    }

    /**
     * Inicializar toda la aplicaci√≥n paso a paso
     */
    private fun initializeApp() {
        lifecycleScope.launch {
            try {
                Log.d("MAIN_ACTIVITY", "üîß === PASO 1: Inicializando RetrofitClient ===")

                // Paso 1: Inicializar RetrofitClient
                val initSuccess = RetrofitClient.initialize(this@MainActivity)

                if (!initSuccess) {
                    Log.e("MAIN_ACTIVITY", "‚ùå Fallo cr√≠tico inicializando RetrofitClient")
                    showErrorDialog(
                        "Error de Configuraci√≥n",
                        "No se pudo inicializar la conexi√≥n con el servidor.\n\n" +
                                "Posibles causas:\n" +
                                "‚Ä¢ Sin conexi√≥n a Internet\n" +
                                "‚Ä¢ Servidor no disponible\n" +
                                "‚Ä¢ Configuraci√≥n incorrecta\n\n" +
                                "¬øQuieres intentar de nuevo?",
                        onRetry = { initializeApp() },
                        onCancel = { finish() }
                    )
                    return@launch
                }

                Log.d("MAIN_ACTIVITY", "‚úÖ RetrofitClient inicializado correctamente")

                // Debug del estado
                RetrofitClient.debugStatus()

                // Peque√±a pausa para que se complete la inicializaci√≥n
                delay(500)

                Log.d("MAIN_ACTIVITY", "üîß === PASO 2: Verificando estado del usuario ===")

                // Paso 2: Verificar estado del usuario
                checkUserAuthenticationStatus()

            } catch (e: Exception) {
                Log.e("MAIN_ACTIVITY", "üí• Error cr√≠tico durante inicializaci√≥n: ${e.message}")
                e.printStackTrace()

                showErrorDialog(
                    "Error Cr√≠tico",
                    "Ocurri√≥ un error inesperado:\n${e.message}\n\n¬øQuieres reintentar?",
                    onRetry = { initializeApp() },
                    onCancel = { finish() }
                )
            }
        }
    }

    /**
     * Verificar estado de autenticaci√≥n del usuario
     */
    private suspend fun checkUserAuthenticationStatus() {
        try {
            val hasToken = RetrofitClient.isLoggedIn()

            Log.d("MAIN_ACTIVITY", "üîê Usuario tiene token guardado: $hasToken")

            if (hasToken) {
                Log.d("MAIN_ACTIVITY", "üîç Verificando validez del token con el servidor...")
                verifyTokenWithServer()
            } else {
                Log.d("MAIN_ACTIVITY", "üîì No hay token - Redirigiendo al login")
                goToLogin("Primera vez o sesi√≥n expirada")
            }

        } catch (e: Exception) {
            Log.e("MAIN_ACTIVITY", "‚ùå Error verificando autenticaci√≥n: ${e.message}")
            e.printStackTrace()

            // En caso de error, ir al login por seguridad
            goToLogin("Error verificando sesi√≥n")
        }
    }

    /**
     * Verificar token con el servidor y obtener datos del usuario
     */
    private suspend fun verifyTokenWithServer() {
        try {
            Log.d("MAIN_ACTIVITY", "üì° Llamando a /api/auth/me/ para verificar token...")

            val apiService = RetrofitClient.getApiService()
            val response = apiService.getCurrentUser()

            Log.d("MAIN_ACTIVITY", "üìä Response code: ${response.code()}")
            Log.d("MAIN_ACTIVITY", "üìä Response successful: ${response.isSuccessful}")

            if (response.isSuccessful && response.body() != null) {
                val user = response.body()!!

                Log.d("MAIN_ACTIVITY", "‚úÖ === USUARIO AUTENTICADO CORRECTAMENTE ===")
                Log.d("MAIN_ACTIVITY", "üë§ ID: ${user.id}")
                Log.d("MAIN_ACTIVITY", "üë§ Nombre: ${user.nombre} ${user.apellidos}")
                Log.d("MAIN_ACTIVITY", "üìß Email: ${user.email}")
                Log.d("MAIN_ACTIVITY", "üè∑Ô∏è Rol: '${user.rol}'")
                Log.d("MAIN_ACTIVITY", "üëë isStaff: ${user.isStaff}")
                Log.d("MAIN_ACTIVITY", "‚úÖ Activo: ${user.activo}")

                // Determinar tipo de dashboard seg√∫n rol
                redirectToAppropriiateDashboard(user)

            } else {
                val errorBody = response.errorBody()?.string()

                Log.w("MAIN_ACTIVITY", "‚ùå Token inv√°lido o expirado")
                Log.w("MAIN_ACTIVITY", "üìä Response code: ${response.code()}")
                Log.w("MAIN_ACTIVITY", "üìä Error body: $errorBody")

                when (response.code()) {
                    401 -> {
                        Log.w("MAIN_ACTIVITY", "üö® 401 Unauthorized - Token expirado")
                        RetrofitClient.clearToken()
                        goToLogin("Tu sesi√≥n ha expirado")
                    }
                    403 -> {
                        Log.w("MAIN_ACTIVITY", "üö´ 403 Forbidden - Sin permisos")
                        RetrofitClient.clearToken()
                        goToLogin("Sin permisos de acceso")
                    }
                    404 -> {
                        Log.e("MAIN_ACTIVITY", "üîç 404 - Endpoint /auth/me/ no encontrado")
                        // Probablemente problema del servidor, usar dashboard por defecto
                        Log.w("MAIN_ACTIVITY", "‚ö†Ô∏è Usando dashboard por defecto debido a error del servidor")
                        goToDefaultDashboard()
                    }
                    500 -> {
                        Log.e("MAIN_ACTIVITY", "üí• 500 - Error interno del servidor")
                        goToDefaultDashboard()
                    }
                    else -> {
                        Log.w("MAIN_ACTIVITY", "‚ö†Ô∏è Error desconocido: ${response.code()}")
                        goToDefaultDashboard()
                    }
                }
            }

        } catch (e: java.net.UnknownHostException) {
            Log.e("MAIN_ACTIVITY", "üåê Error: Servidor no encontrado")
            showConnectionError("Servidor no encontrado",
                "Verifica que el servidor est√© ejecut√°ndose y la URL sea correcta.")

        } catch (e: java.net.ConnectException) {
            Log.e("MAIN_ACTIVITY", "üîó Error: No se puede conectar al servidor")
            showConnectionError("Sin conexi√≥n al servidor",
                "El servidor no responde. Verifica tu conexi√≥n a Internet.")

        } catch (e: java.net.SocketTimeoutException) {
            Log.e("MAIN_ACTIVITY", "‚è±Ô∏è Error: Timeout de conexi√≥n")
            showConnectionError("Conexi√≥n lenta",
                "El servidor tard√≥ demasiado en responder.")

        } catch (e: Exception) {
            Log.e("MAIN_ACTIVITY", "üí• Error inesperado verificando token: ${e.message}")
            e.printStackTrace()

            // En caso de error de conexi√≥n, ir al dashboard por defecto
            Log.w("MAIN_ACTIVITY", "‚ö†Ô∏è Error de red - Usando dashboard por defecto")
            goToDefaultDashboard()
        }
    }

    /**
     * Redirigir al dashboard apropiado seg√∫n el rol del usuario
     */
    private fun redirectToAppropriiateDashboard(user: com.example.genetics.api.Usuario) {
        try {
            // L√≥gica de roles mejorada
            val isAdmin = user.rol?.trim()?.lowercase() == "admin" || user.isStaff == true

            if (isAdmin) {
                Log.d("MAIN_ACTIVITY", "üëë === ACCESO ADMINISTRADOR ===")
                Log.d("MAIN_ACTIVITY", "üéØ Abriendo DashboardActivity (Admin)")

                Toast.makeText(this, "¬°Bienvenido, Admin ${user.nombre}! üëë", Toast.LENGTH_SHORT).show()

                val intent = Intent(this, DashboardActivity::class.java)
                intent.putExtra("USER_NAME", "${user.nombre} ${user.apellidos}")
                intent.putExtra("USER_ROLE", user.rol)
                startActivity(intent)

            } else {
                Log.d("MAIN_ACTIVITY", "üë§ === ACCESO USUARIO NORMAL ===")
                Log.d("MAIN_ACTIVITY", "üéØ Abriendo UserDashboardActivity")

                Toast.makeText(this, "¬°Bienvenido, ${user.nombre}! üë§", Toast.LENGTH_SHORT).show()

                val intent = Intent(this, UserDashboardActivity::class.java)
                intent.putExtra("USER_NAME", "${user.nombre} ${user.apellidos}")
                intent.putExtra("USER_ROLE", user.rol)
                startActivity(intent)
            }

            finish()

        } catch (e: Exception) {
            Log.e("MAIN_ACTIVITY", "‚ùå Error redirigiendo al dashboard: ${e.message}")
            e.printStackTrace()
            goToDefaultDashboard()
        }
    }

    /**
     * Ir al dashboard por defecto (usuario normal)
     */
    private fun goToDefaultDashboard() {
        Log.d("MAIN_ACTIVITY", "üéØ Usando dashboard por defecto (UserDashboard)")
        Toast.makeText(this, "¬°Bienvenido a Genetics!", Toast.LENGTH_SHORT).show()

        startActivity(Intent(this, UserDashboardActivity::class.java))
        finish()
    }

    /**
     * Ir al login con mensaje opcional
     */
    private fun goToLogin(reason: String? = null) {
        Log.d("MAIN_ACTIVITY", "üîÑ Redirigiendo al login")

        if (reason != null) {
            Log.d("MAIN_ACTIVITY", "üìù Raz√≥n: $reason")
            Toast.makeText(this, reason, Toast.LENGTH_SHORT).show()
        }

        val intent = Intent(this, LoginActivity::class.java)
        if (reason != null) {
            intent.putExtra("MESSAGE", reason)
        }

        startActivity(intent)
        finish()
    }

    /**
     * Mostrar di√°logo de error de conexi√≥n
     */
    private fun showConnectionError(title: String, message: String) {
        androidx.appcompat.app.AlertDialog.Builder(this)
            .setTitle("üåê $title")
            .setMessage("$message\n\n¬øQu√© quieres hacer?")
            .setPositiveButton("üîÑ Reintentar") { _, _ ->
                isProcessing = false
                initializeApp()
            }
            .setNeutralButton("üîß Configuraci√≥n") { _, _ ->
                // Aqu√≠ podr√≠as abrir una pantalla de configuraci√≥n
                Toast.makeText(this, "Configuraci√≥n - Pr√≥ximamente", Toast.LENGTH_SHORT).show()
                goToLogin()
            }
            .setNegativeButton("üö™ Salir") { _, _ ->
                finish()
            }
            .setCancelable(false)
            .show()
    }

    /**
     * Mostrar di√°logo de error gen√©rico
     */
    private fun showErrorDialog(
        title: String,
        message: String,
        onRetry: () -> Unit,
        onCancel: () -> Unit
    ) {
        androidx.appcompat.app.AlertDialog.Builder(this)
            .setTitle("‚ö†Ô∏è $title")
            .setMessage(message)
            .setPositiveButton("üîÑ Reintentar") { _, _ ->
                isProcessing = false
                onRetry()
            }
            .setNegativeButton("‚ùå Cancelar") { _, _ ->
                onCancel()
            }
            .setCancelable(false)
            .show()
    }

    override fun onNewIntent(intent: Intent?) {
        super.onNewIntent(intent)
        Log.d("MAIN_ACTIVITY", "üîÑ onNewIntent llamado")

        // Si llegamos aqu√≠ desde un intent externo y ya estamos procesando, no hacer nada
        if (!isProcessing) {
            isProcessing = false
            initializeApp()
        }
    }

    override fun onBackPressed() {
        // En MainActivity, el bot√≥n atr√°s debe cerrar la app
        Log.d("MAIN_ACTIVITY", "üîô Back presionado - Cerrando app")
        super.onBackPressed()
        finishAffinity() // Cerrar toda la aplicaci√≥n
    }

    override fun onDestroy() {
        super.onDestroy()
        Log.d("MAIN_ACTIVITY", "üóëÔ∏è MainActivity destruida")
        isProcessing = false
    }
}